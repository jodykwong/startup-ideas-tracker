---
import Layout from '@/layouts/Layout.astro'
import { supabase } from '@/lib/supabase'

// Handle auth callback
const url = new URL(Astro.request.url)
const code = url.searchParams.get('code')
const error = url.searchParams.get('error')
const errorDescription = url.searchParams.get('error_description')

let authError = null
let authSuccess = false

if (error) {
  authError = errorDescription || error
} else if (code) {
  try {
    const { data, error: exchangeError } = await supabase.auth.exchangeCodeForSession(code)
    if (exchangeError) {
      authError = exchangeError.message
    } else {
      authSuccess = true
      // Redirect to dashboard after successful auth
      return Astro.redirect('/dashboard')
    }
  } catch (err) {
    authError = 'Failed to process authentication'
  }
}
---

<Layout title="认证回调 - Startup Ideas Tracker">
  <div class="min-h-screen flex items-center justify-center bg-neutral-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
      <div class="text-center">
        {authSuccess ? (
          <div class="space-y-4">
            <div class="flex items-center justify-center w-16 h-16 mx-auto bg-success-100 rounded-full">
              <svg class="w-8 h-8 text-success-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            </div>
            <h2 class="text-2xl font-bold text-neutral-900">认证成功</h2>
            <p class="text-neutral-600">正在跳转到控制台...</p>
            <div class="loading-spinner w-6 h-6 mx-auto"></div>
          </div>
        ) : authError ? (
          <div class="space-y-4">
            <div class="flex items-center justify-center w-16 h-16 mx-auto bg-error-100 rounded-full">
              <svg class="w-8 h-8 text-error-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </div>
            <h2 class="text-2xl font-bold text-neutral-900">认证失败</h2>
            <p class="text-error-600">{authError}</p>
            <div class="space-y-3">
              <a href="/auth" class="btn-primary w-full justify-center">
                重新登录
              </a>
              <a href="/" class="btn-ghost w-full justify-center">
                返回首页
              </a>
            </div>
          </div>
        ) : (
          <div class="space-y-4">
            <div class="loading-spinner w-8 h-8 mx-auto"></div>
            <h2 class="text-2xl font-bold text-neutral-900">处理认证中...</h2>
            <p class="text-neutral-600">请稍候，正在验证您的身份</p>
          </div>
        )}
      </div>
    </div>
  </div>
</Layout>

<script>
  // Auto redirect on success
  if (window.location.search.includes('code=') && !window.location.search.includes('error=')) {
    setTimeout(() => {
      window.location.href = '/dashboard'
    }, 2000)
  }
</script>
